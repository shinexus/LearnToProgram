# .github/workflows/daily-hiddify.yml
name: Daily HiddifyConfigsCLI

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: windows-latest
    timeout-minutes: 80

    steps:
      # -------------------------------------------------
      - name: 1. 拉取仓库
        uses: actions/checkout@v4

      # -------------------------------------------------
      - name: 2. 运行 CLI（输出到 exe 目录）
        id: run_exe
        shell: pwsh
        timeout-minutes: 70
        run: |
          $exeDir = "HiddifyConfigsCLI/bin/Debug/net9.0"
          Set-Location $exeDir

          Write-Host "=== 当前工作目录 ==="
          Write-Host (Get-Location)

          $exe = "HiddifyConfigsCLI.exe"
          if (!(Test-Path $exe)) { Write-Error "EXE 不存在: $exe"; exit 1 }

          $input = "https://raw.githubusercontent.com/shinexus/LearnToProgram/refs/heads/master/HiddifyConfigsCLI/config/urls.txt"

          $params = @(
            "--input", $input
            "--output", "valid_links.txt"
            "--max-lines", "100"
            "--max-parts", "2"
            "--timeout", "6"
            "--parallel", "256"
            "--http-timeout", "5"
          )

          & ".\$exe" @params
          $code = $LASTEXITCODE
          Write-Host "CLI 退出码: $code"
          if ($code -ne 0) { exit $code }

      # -------------------------------------------------
      - name: 3. 列出生成文件
        if: always()
        shell: pwsh
        run: |
          Write-Host "=== 当前生成的 valid_links 文件 ==="
          Get-ChildItem -Path "HiddifyConfigsCLI/bin/Debug/net9.0" -Filter "valid_links*" |
            Format-Table Name, FullName, Length

      # -------------------------------------------------
      - name: 4. 上传产物
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: valid-links
          path: HiddifyConfigsCLI/bin/Debug/net9.0/valid_links*
          retention-days: 7
          if-no-files-found: warn

      # -------------------------------------------------
      - name: 5. 提交结果（自动提交 valid_links 文件）
        if: always() && steps.run_exe.outcome == 'success'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Set-Location $env:GITHUB_WORKSPACE

          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git config pull.rebase false
          git pull origin ${{ github.ref }} --no-edit || echo "无需 pull"

          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 收集 valid_links* 文件（使用相对路径）
          # 直接使用最稳的写法：cd 到目标目录后 add .
          Set-Location "HiddifyConfigsCLI/bin/Debug/net9.0"
          git add .

          # 再次回到根目录进行 commit（git 本身不依赖当前目录）
          Set-Location $env:GITHUB_WORKSPACE

          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "文件无变化，跳过 commit"
            exit 0
          }
          git push origin HEAD:${{ github.ref }} --force
