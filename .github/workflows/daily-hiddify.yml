name: Daily HiddifyConfigsCLI Run

# 每天 UTC 03:00 执行（北京时间 11:00，如需北京 03:00 改为 '0 19 * * *'）
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  
permissions:
    contents: write  # ✅ 允许推送修改

jobs:
  run-cli:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # ✅ 使用 GITHUB_TOKEN 自动认证

      # 【关键】如果 exe 已随仓库提交，则无需 Restore/Build
      # - name: Setup .NET 8          # ← 可删除
      #   uses: actions/setup-dotnet@v4
      #   with:
      #     dotnet-version: '8.0.x'
      #
      # - name: Restore dependencies  # ← 可删除
      #   run: dotnet restore ...
      #
      # - name: Build (Debug)         # ← 可删除
      #   run: dotnet build ...

      - name: Run Pre-built HiddifyConfigsCLI.exe
        env:
          CLI_ARGS: >-
     #       --input urls.txt
            --input https://raw.githubusercontent.com/shinexus/LearnToProgram/refs/heads/master/HiddifyConfigsCLI/bin/Debug/net8.0/urls.txt
            --output valid_links.txt
            --max-lines 100
            --max-parts 2
            --timeout 3
            --parallel 20
            --sort latency
            --http-timeout 10
            --verbose
        run: |
          $exe = "./HiddifyConfigsCLI/bin/Debug/net8.0/HiddifyConfigsCLI.exe"
          if (-not (Test-Path $exe)) {
            Write-Error "EXE not found: $exe"
            exit 1
          }
          & $exe $env:CLI_ARGS
        shell: pwsh

      - name: Upload valid_links.txt as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: valid-links
          path: |
            valid_links.txt
            valid_links_01.txt
            valid_links_02.txt
          retention-days: 7

      - name: Commit & push results (optional)
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add valid_*.txt
          git commit -m "Auto-update valid links $(Get-Date -Format 'yyyy-MM-dd HH:mm')" || echo "Nothing to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
