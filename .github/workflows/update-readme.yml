# .github/workflows/update-readme.yml
name: Update README Dates

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Dates
        id: d
        run: |
          f() {
            if git log -1 --format=%cI -- "$1" >/dev/null 2>&1; then
              TZ=UTC git log -1 --format=%cI -- "$1" | xargs -I {} date -d "{} + 8 hours" +"%Y-%m-%d %H:%M:%S +0800"
            else
              echo "N/A"
            fi
          }
          echo "ALL=$(f 'HiddifyConfigsCLI/bin/Debug/net8.0/valid_links.txt')" >> $GITHUB_OUTPUT
          echo "01=$(f 'HiddifyConfigsCLI/bin/Debug/net8.0/valid_links_01.txt')" >> $GITHUB_OUTPUT
          echo "02=$(f 'HiddifyConfigsCLI/bin/Debug/net8.0/valid_links_02.txt')" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          sed -i "s|UPDATE_ALL|[Last updated: ${{ steps.d.outputs.ALL }}]|g" README.md
          sed -i "s|UPDATE_01|[Last updated: ${{ steps.d.outputs.01 }}]|g" README.md
          sed -i "s|UPDATE_02|[Last updated: ${{ steps.d.outputs.02 }}]|g" README.md

      - name: Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"
          git add README.md
          git commit -m "Update dates [skip ci]" || exit 0
          git push || echo "Nothing to push"
